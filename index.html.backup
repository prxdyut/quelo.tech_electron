<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quelo.Tech Config</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
  </style>
</head>
<body>
  <div class="min-h-screen">
    <!-- Sidebar Navigation -->
    <div class="fixed left-0 top-0 h-full w-16 flex flex-col items-center py-6 gap-4" style="background-color: #0d0d0d; border-right: 1px solid #1f2937;">
      <div class="w-10 h-10 rounded-lg flex items-center justify-center mb-4" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
        <span class="text-white font-bold text-sm">QT</span>
      </div>
      
      <button id="navFiles" class="nav-btn active w-10 h-10 rounded-lg flex items-center justify-center transition hover:bg-gray-800" title="Files">
        <i data-lucide="files" class="w-5 h-5"></i>
      </button>
      
      <button id="navCaptures" class="nav-btn w-10 h-10 rounded-lg flex items-center justify-center transition hover:bg-gray-800" title="Captures">
        <i data-lucide="image" class="w-5 h-5"></i>
      </button>
      
      <div class="flex-1"></div>
      
      <button id="navSettings" class="nav-btn w-10 h-10 rounded-lg flex items-center justify-center transition hover:bg-gray-800" title="Settings">
        <i data-lucide="settings" class="w-5 h-5"></i>
      </button>
    </div>

    <!-- Main Content -->
    <div class="ml-16 p-6">
      <!-- Header -->
      <div class="max-w-7xl mx-auto mb-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h1 class="text-2xl font-semibold text-white">Quelo.Tech Config</h1>
            <p class="text-sm text-gray-500 mt-1">Manage your files and captures</p>
          </div>
          
          <div class="flex gap-3 items-center">
            <!-- Auth Status -->
            <div id="authStatus" class="px-3 py-2 rounded-lg bg-gray-800 flex items-center gap-2">
              <i data-lucide="user" class="w-4 h-4"></i>
              <span id="authStatusText" class="text-sm text-gray-400">Not logged in</span>
            </div>
            
            <button id="loginBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
              <i data-lucide="lock" class="w-4 h-4"></i>
              <span>Login</span>
            </button>
            <button id="logoutBtn" class="hidden px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition">
              Logout
            </button>
          </div>
        </div>

        <!-- Action Bar -->
        <div class="flex items-center gap-3 mb-6">
          <button id="recordBtn" class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition flex items-center gap-2">
            <i data-lucide="mic" class="w-4 h-4"></i>
            <span>Record</span>
          </button>
          
          <button id="stopRecordBtn" class="hidden px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition flex items-center gap-2">
            <i data-lucide="square" class="w-4 h-4"></i>
            <span>Stop & Save</span>
          </button>
          
          <button id="overlayBtn" class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition flex items-center gap-2">
            <i data-lucide="camera" class="w-4 h-4"></i>
            <span>Widget</span>
          </button>
          
          <div class="flex-1"></div>
          
          <button id="openQueloBtn" class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition flex items-center gap-2">
            <i data-lucide="external-link" class="w-4 h-4"></i>
            <span>Open Quelo.Tech</span>
          </button>
          
          <button id="stopBtn" disabled class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
            Stop Sync
          </button>
        </div>

        </div>

        <!-- Files View -->
        <div id="filesView" class="view-content">
          <!-- Folder Info -->
          <div id="folderInfo" class="hidden rounded-lg p-3 mb-4" style="background-color: #0d1117; border: 1px solid #1f2937;">
            <p class="text-sm text-gray-300">
              <span class="font-medium">Watching:</span>
              <span id="folderPath" class="font-mono text-xs text-gray-400"></span>
            </p>
          </div>

          <!-- Filters -->
          <div class="rounded-lg p-4 mb-4" style="background-color: #0d1117; border: 1px solid #1f2937;">
            <div class="flex items-center gap-3">
              <div class="flex-1">
                <input 
                  type="text" 
                  id="searchInput" 
                  placeholder="Search files..."
                  class="w-full px-3 py-2 text-white text-sm rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none placeholder-gray-500"
                  style="background-color: #1a1a1a; border: 1px solid #2a2a2a;"
                >
              </div>
              <input 
                type="date" 
                id="fromDate" 
                class="px-3 py-2 text-white text-sm rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
                style="background-color: #1a1a1a; border: 1px solid #2a2a2a;"
              >
              <input 
                type="date" 
                id="toDate" 
                class="px-3 py-2 text-white text-sm rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
                style="background-color: #1a1a1a; border: 1px solid #2a2a2a;"
              >
              <button id="clearFiltersBtn" class="px-3 py-2 text-gray-300 text-sm rounded-md hover:bg-gray-800 transition" style="border: 1px solid #2a2a2a;">
                Clear
              </button>
            </div>
          </div>

          <!-- Stats -->
          <div class="grid grid-cols-4 gap-3 mb-6">
            <div class="rounded-lg p-4" style="background-color: #0d1117; border: 1px solid #1f2937;">
              <div class="text-xs text-gray-500 mb-1">Total Files</div>
              <div class="text-2xl font-semibold text-white" id="statTotal">0</div>
            </div>
            <div class="rounded-lg p-4" style="background-color: #0d1117; border: 1px solid #1f2937;">
              <div class="text-xs text-gray-500 mb-1">Synced</div>
              <div class="text-2xl font-semibold text-blue-400" id="statSynced">0</div>
            </div>
            <div class="rounded-lg p-4" style="background-color: #0d1117; border: 1px solid #1f2937;">
              <div class="text-xs text-gray-500 mb-1">Syncing</div>
              <div class="text-2xl font-semibold text-blue-300" id="statSyncing">0</div>
            </div>
            <div class="rounded-lg p-4" style="background-color: #0d1117; border: 1px solid #1f2937;">
              <div class="text-xs text-gray-500 mb-1">Errors</div>
              <div class="text-2xl font-semibold text-red-400" id="statErrors">0</div>
            </div>
          </div>

          <!-- Files Grid -->
          <div id="filesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <!-- Files will be loaded here -->
          </div>
        </div>

        <!-- Captures View -->
        <div id="capturesView" class="view-content hidden">
          <!-- Tabs -->
          <div class="mb-6 flex items-center gap-4 border-b" style="border-color: #1f2937;">
            <button id="tabScreenshots" class="capture-tab active px-4 py-3 text-sm font-medium transition border-b-2" style="border-color: #3b82f6; color: #3b82f6;">
              <i data-lucide="image" class="w-4 h-4 inline mr-2"></i>
              Screenshots
            </button>
            <button id="tabRecordings" class="capture-tab px-4 py-3 text-sm font-medium transition border-b-2 border-transparent" style="color: #6b7280;">
              <i data-lucide="mic" class="w-4 h-4 inline mr-2"></i>
              Recordings
            </button>
          </div>

          <!-- Screenshots Tab -->
          <div id="screenshotsTab" class="capture-tab-content">
            <div class="mb-4 flex items-center justify-between">
              <div>
                <h2 class="text-lg font-semibold text-white">Screenshots</h2>
                <p class="text-sm text-gray-500 mt-1">Select screenshots to save as notes (converted to PDF)</p>
              </div>
              <div class="flex gap-2">
                <button id="selectAllScreenshotsBtn" class="px-3 py-1.5 text-sm bg-gray-800 text-white rounded-md hover:bg-gray-700 transition">
                  Select All
                </button>
                <button id="deselectAllScreenshotsBtn" class="px-3 py-1.5 text-sm bg-gray-800 text-white rounded-md hover:bg-gray-700 transition">
                  Deselect All
                </button>
                <button id="saveScreenshotsBtn" class="px-4 py-1.5 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition flex items-center gap-2">
                  <i data-lucide="file-text" class="w-4 h-4"></i>
                  <span>Save as Notes</span>
                </button>
                <button id="deleteScreenshotsBtn" class="px-3 py-1.5 text-sm bg-red-600 text-white rounded-md hover:bg-red-700 transition flex items-center gap-2">
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                  <span>Delete</span>
                </button>
              </div>
            </div>

            <div id="screenshotsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
              <!-- Screenshots will be loaded here -->
            </div>
          </div>

          <!-- Recordings Tab -->
          <div id="recordingsTab" class="capture-tab-content hidden">
            <div class="mb-4 flex items-center justify-between">
              <div>
                <h2 class="text-lg font-semibold text-white">Audio Recordings</h2>
                <p class="text-sm text-gray-500 mt-1">Select recordings to save as notes</p>
              </div>
              <div class="flex gap-2">
                <button id="selectAllRecordingsBtn" class="px-3 py-1.5 text-sm bg-gray-800 text-white rounded-md hover:bg-gray-700 transition">
                  Select All
                </button>
                <button id="deselectAllRecordingsBtn" class="px-3 py-1.5 text-sm bg-gray-800 text-white rounded-md hover:bg-gray-700 transition">
                  Deselect All
                </button>
                <button id="saveRecordingsBtn" class="px-4 py-1.5 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition flex items-center gap-2">
                  <i data-lucide="file-audio" class="w-4 h-4"></i>
                  <span>Save as Notes</span>
                </button>
                <button id="deleteRecordingsBtn" class="px-3 py-1.5 text-sm bg-red-600 text-white rounded-md hover:bg-red-700 transition flex items-center gap-2">
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                  <span>Delete</span>
                </button>
              </div>
            </div>

            <div id="recordingsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
              <!-- Recordings will be loaded here -->
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 transition-opacity duration-300">
    <div class="rounded-xl shadow-2xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto" style="background-color: #0d1117; border: 1px solid #1f2937;">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-semibold text-white">Settings</h2>
        <button id="closeSettingsBtn" class="text-gray-400 hover:text-white transition">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      
      <div class="space-y-5">
        <!-- API Configuration -->
        <div>
          <h3 class="text-sm font-semibold text-gray-300 mb-3">API Configuration</h3>
          <div>
            <label class="block text-xs font-medium text-gray-400 mb-2">API Base URL</label>
            <input 
              type="text" 
              id="apiBaseUrl" 
              placeholder="https://dev.quelo.tech"
              class="w-full px-3 py-2 text-white text-sm rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none placeholder-gray-600"
              style="background-color: #1a1a1a; border: 1px solid #2a2a2a;"
            >
            <p class="text-xs text-gray-500 mt-1.5">Backend API URL for file uploads and sync</p>
          </div>
        </div>

        <!-- Sync Settings -->
        <div class="border-t pt-4" style="border-color: #1f2937;">
          <h3 class="text-sm font-semibold text-gray-300 mb-3">Sync Settings</h3>
          
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <div>
                <label class="text-sm text-gray-300">Auto Sync</label>
                <p class="text-xs text-gray-500">Automatically sync files when changes are detected</p>
              </div>
              <input type="checkbox" id="autoSync" class="w-4 h-4 rounded border-gray-600 text-blue-600">
            </div>

            <div class="flex items-center justify-between">
              <div>
                <label class="text-sm text-gray-300">Auto Start</label>
                <p class="text-xs text-gray-500">Start syncing automatically when app launches</p>
              </div>
              <input type="checkbox" id="autoStart" class="w-4 h-4 rounded border-gray-600 text-blue-600">
            </div>

            <div>
              <label class="block text-xs font-medium text-gray-400 mb-2">Sync Interval (seconds)</label>
              <input 
                type="number" 
                id="syncInterval" 
                min="0"
                placeholder="0 (immediate)"
                class="w-full px-3 py-2 text-white text-sm rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none placeholder-gray-600"
                style="background-color: #1a1a1a; border: 1px solid #2a2a2a;"
              >
              <p class="text-xs text-gray-500 mt-1.5">Set to 0 for immediate sync, or specify delay</p>
            </div>

            <div>
              <label class="block text-xs font-medium text-gray-400 mb-2">Max File Size (MB)</label>
              <input 
                type="number" 
                id="maxFileSize" 
                min="1"
                placeholder="100"
                class="w-full px-3 py-2 text-white text-sm rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none placeholder-gray-600"
                style="background-color: #1a1a1a; border: 1px solid #2a2a2a;"
              >
              <p class="text-xs text-gray-500 mt-1.5">Maximum file size to sync (in megabytes)</p>
            </div>

            <div class="flex items-center justify-between">
              <div>
                <label class="text-sm text-gray-300">Ignore Hidden Files</label>
                <p class="text-xs text-gray-500">Skip files starting with a dot (.)</p>
              </div>
              <input type="checkbox" id="ignoreHidden" class="w-4 h-4 rounded border-gray-600 text-blue-600">
            </div>
          </div>
        </div>

        <!-- Capture Settings -->
        <div class="border-t pt-4" style="border-color: #1f2937;">
          <h3 class="text-sm font-semibold text-gray-300 mb-3">Capture & Recording</h3>
          
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <div>
                <label class="text-sm text-gray-300">Auto-save Screenshots</label>
                <p class="text-xs text-gray-500">Automatically save screenshots to watch folder</p>
              </div>
              <input type="checkbox" id="autoSaveScreenshots" class="w-4 h-4 rounded border-gray-600 text-blue-600">
            </div>

            <div>
              <label class="block text-xs font-medium text-gray-400 mb-2">Screenshot Format</label>
              <select 
                id="screenshotFormat" 
                class="w-full px-3 py-2 text-white text-sm rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
                style="background-color: #1a1a1a; border: 1px solid #2a2a2a;"
              >
                <option value="png">PNG (High Quality)</option>
                <option value="jpg">JPG (Smaller Size)</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-medium text-gray-400 mb-2">Recording Audio Format</label>
              <select 
                id="audioFormat" 
                class="w-full px-3 py-2 text-white text-sm rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
                style="background-color: #1a1a1a; border: 1px solid #2a2a2a;"
              >
                <option value="webm">WebM (Best Compatibility)</option>
                <option value="mp3">MP3</option>
                <option value="wav">WAV (Uncompressed)</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-medium text-gray-400 mb-2">Recording Chunk Size (seconds)</label>
              <input 
                type="number" 
                id="recordingChunkSize" 
                min="5"
                max="60"
                placeholder="10"
                class="w-full px-3 py-2 text-white text-sm rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none placeholder-gray-600"
                style="background-color: #1a1a1a; border: 1px solid #2a2a2a;"
              >
              <p class="text-xs text-gray-500 mt-1.5">How often to save recording chunks (prevents data loss)</p>
            </div>
          </div>
        </div>

        <!-- Application Settings -->
        <div class="border-t pt-4" style="border-color: #1f2937;">
          <h3 class="text-sm font-semibold text-gray-300 mb-3">Application</h3>
          
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <div>
                <label class="text-sm text-gray-300">Start with Windows</label>
                <p class="text-xs text-gray-500">Launch app automatically on system startup</p>
              </div>
              <input type="checkbox" id="startWithWindows" class="w-4 h-4 rounded border-gray-600 text-blue-600">
            </div>

            <div class="flex items-center justify-between">
              <div>
                <label class="text-sm text-gray-300">Minimize to Tray</label>
                <p class="text-xs text-gray-500">Hide window to system tray when minimized</p>
              </div>
              <input type="checkbox" id="minimizeToTray" class="w-4 h-4 rounded border-gray-600 text-blue-600">
            </div>

            <div class="flex items-center justify-between">
              <div>
                <label class="text-sm text-gray-300">Show Notifications</label>
                <p class="text-xs text-gray-500">Display desktop notifications for sync events</p>
              </div>
              <input type="checkbox" id="showNotifications" class="w-4 h-4 rounded border-gray-600 text-blue-600">
            </div>

            <div>
              <label class="block text-xs font-medium text-gray-400 mb-2">Theme</label>
              <select 
                id="appTheme" 
                class="w-full px-3 py-2 text-white text-sm rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
                style="background-color: #1a1a1a; border: 1px solid #2a2a2a;"
              >
                <option value="dark">Dark</option>
                <option value="light">Light</option>
                <option value="auto">Auto (System)</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="rounded-lg p-3" style="background-color: #0a1929; border: 1px solid #1e3a5f;">
          <p class="text-xs text-blue-300">
            <strong>Note:</strong> Authentication is handled via web login. Click the "Login" button in the header to authenticate.
          </p>
        </div>
        
        <!-- Upload Records Section -->
        <div class="border-t pt-4" style="border-color: #1f2937;">
          <h3 class="text-sm font-semibold text-gray-300 mb-3">Upload Records</h3>
          <div class="rounded-lg p-3 mb-2" style="background-color: #1a1a1a; border: 1px solid #2a2a2a;">
            <div class="flex justify-between items-center mb-2">
              <span class="text-xs text-gray-400">Total files tracked:</span>
              <span id="uploadRecordsCount" class="text-sm font-semibold text-white">0</span>
            </div>
            <p class="text-xs text-gray-500 mb-2">
              The app tracks uploaded files to avoid re-uploading unchanged files. This saves bandwidth and time.
            </p>
            <button id="syncFromServerBtn" class="w-full px-3 py-2 text-white rounded-md hover:bg-blue-700 transition text-xs mb-2 bg-blue-600">
              <i data-lucide="refresh-cw" class="inline w-3 h-3"></i> Sync from Server
            </button>
          </div>
          <button id="clearRecordsBtn" class="w-full px-3 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-600 transition text-sm">
            Clear Upload Records
          </button>
          <p class="text-xs text-gray-500 mt-1.5">This will force all files to be re-uploaded on next sync</p>
        </div>
        
        <div class="flex gap-2 pt-4">
          <button id="saveSettingsBtn" class="flex-1 px-3 py-2 text-white rounded-md hover:bg-blue-700 transition text-sm bg-blue-600">
            Save Settings
          </button>
          <button id="cancelSettingsBtn" class="flex-1 px-3 py-2 text-gray-300 rounded-md hover:bg-gray-700 transition text-sm bg-gray-800">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload Progress Modal -->
  <div id="uploadProgressModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 transition-opacity duration-300">
    <div class="rounded-xl shadow-2xl max-w-lg w-full p-6" style="background-color: #0d1117; border: 1px solid #1f2937;">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-white">Uploading File</h2>
        <button id="closeUploadModalBtn" class="text-gray-400 hover:text-white transition">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      
      <div class="space-y-4">
        <div>
          <div class="flex justify-between text-sm mb-2">
            <span id="uploadFileName" class="font-medium text-white">file.pdf</span>
            <span id="uploadStatusText" class="text-xs text-gray-500">Initializing...</span>
          </div>
          
          <!-- Upload Progress -->
          <div class="mb-3">
            <div class="flex justify-between text-xs text-gray-400 mb-1.5">
              <span>Upload Progress</span>
              <span id="uploadPercent">0%</span>
            </div>
            <div class="w-full rounded-full h-1.5" style="background-color: #1a1a1a;">
              <div id="uploadProgressBar" class="h-1.5 rounded-full transition-all" style="width: 0%; background-color: #3b82f6;"></div>
            </div>
            <div class="flex justify-between text-xs text-gray-600 mt-1">
              <span id="uploadPartInfo"></span>
              <span id="uploadBytes"></span>
            </div>
          </div>
          
          <!-- Preprocessing Progress -->
          <div id="preprocessSection" class="hidden">
            <div class="flex justify-between text-xs text-gray-400 mb-1.5">
              <span>Processing Document</span>
              <span id="preprocessPercent">0%</span>
            </div>
            <div class="w-full rounded-full h-1.5" style="background-color: #1a1a1a;">
              <div id="preprocessProgressBar" class="h-1.5 rounded-full transition-all" style="width: 0%; background-color: #3b82f6;"></div>
            </div>
            <div class="text-xs text-gray-600 mt-1" id="preprocessPageInfo"></div>
          </div>
        </div>
        
        <div id="uploadError" class="hidden rounded-lg p-3" style="background-color: #2d0f0f; border: 1px solid #4a1818;">
          <p class="text-sm text-red-300" id="uploadErrorText"></p>
        </div>
        
        <div id="uploadSuccess" class="hidden rounded-lg p-3" style="background-color: #0a1929; border: 1px solid #1e3a5f;">
          <p class="text-sm text-blue-300">
            <i data-lucide="check" class="inline w-4 h-4"></i> Upload completed successfully!
            <span id="noteIdDisplay" class="font-mono"></span>
          </p>
        </div>
      </div>
      
      <div class="mt-6 flex gap-2">
        <button id="closeUploadModal" class="flex-1 px-3 py-2 text-white rounded-md hover:bg-gray-700 transition text-sm bg-gray-800">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Captures Modal -->
  <div id="capturesModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 transition-opacity duration-300">
    <div class="rounded-xl shadow-2xl max-w-6xl w-full p-6 max-h-[90vh] overflow-y-auto" style="background-color: #0d1117; border: 1px solid #1f2937;">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-lg font-semibold text-white">Captures</h2>
          <p class="text-xs text-gray-500 mt-1">Review and save your screenshots and audio recordings</p>
        </div>
        <button id="closeCapturesBtn" class="text-gray-400 hover:text-white transition">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      
      <div class="mb-4 flex gap-2">
        <button id="selectAllCapturesBtn" class="px-3 py-1.5 text-sm bg-gray-700 text-white rounded-md hover:bg-gray-600 transition">
          Select All
        </button>
        <button id="deselectAllCapturesBtn" class="px-3 py-1.5 text-sm bg-gray-700 text-white rounded-md hover:bg-gray-600 transition">
          Deselect All
        </button>
        <div class="flex-1"></div>
        <button id="saveSelectedBtn" class="px-4 py-1.5 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition flex items-center gap-2">
          <i data-lucide="save" class="w-4 h-4"></i>
          <span>Save Selected as Notes</span>
        </button>
        <button id="deleteSelectedBtn" class="px-3 py-1.5 text-sm bg-red-600 text-white rounded-md hover:bg-red-700 transition flex items-center gap-2">
          <i data-lucide="trash-2" class="w-4 h-4"></i>
          <span>Delete</span>
        </button>
      </div>

      <div id="capturesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Captures will be loaded here -->
        <div class="col-span-full text-center py-20">
          <div class="text-gray-700 mb-4">
            <i data-lucide="image" class="w-16 h-16 mx-auto"></i>
          </div>
          <h3 class="text-sm font-medium text-gray-500 mb-1">No Captures Yet</h3>
          <p class="text-xs text-gray-600">Take screenshots or record audio to see them here</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    console.log('[Script] JavaScript loading...');
    
    const filesList = document.getElementById('filesList');
    const emptyState = document.getElementById('emptyState');
    const folderInfo = document.getElementById('folderInfo');
    const folderPath = document.getElementById('folderPath');
    const stopBtn = document.getElementById('stopBtn');
    
    console.log('[Script] DOM elements:', { 
      filesList: !!filesList, 
      folderInfo: !!folderInfo,
      folderPath: !!folderPath 
    });
    
    // Auth elements
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authStatus = document.getElementById('authStatus');
    const authStatusText = document.getElementById('authStatusText');
    
    // New buttons
    const openQueloBtn = document.getElementById('openQueloBtn');
    const recordBtn = document.getElementById('recordBtn');
    const stopRecordBtn = document.getElementById('stopRecordBtn');
    const overlayBtn = document.getElementById('overlayBtn');
    
    // Captures Modal (still used for modal view)
    const capturesModal = document.getElementById('capturesModal');
    const closeCapturesBtn = document.getElementById('closeCapturesBtn');
    const capturesGrid = document.getElementById('capturesGrid');
    const selectAllCapturesBtn = document.getElementById('selectAllCapturesBtn');
    const deselectAllCapturesBtn = document.getElementById('deselectAllCapturesBtn');
    const saveSelectedBtn = document.getElementById('saveSelectedBtn');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    
    // Settings
    const settingsModal = document.getElementById('settingsModal');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const apiBaseUrlInput = document.getElementById('apiBaseUrl');
    const autoSyncInput = document.getElementById('autoSync');
    const autoStartInput = document.getElementById('autoStart');
    const syncIntervalInput = document.getElementById('syncInterval');
    const maxFileSizeInput = document.getElementById('maxFileSize');
    const ignoreHiddenInput = document.getElementById('ignoreHidden');
    const uploadRecordsCount = document.getElementById('uploadRecordsCount');
    const clearRecordsBtn = document.getElementById('clearRecordsBtn');
    const syncFromServerBtn = document.getElementById('syncFromServerBtn');
    
    // Upload Progress
    const uploadProgressModal = document.getElementById('uploadProgressModal');
    const closeUploadModal = document.getElementById('closeUploadModal');
    const closeUploadModalBtn = document.getElementById('closeUploadModalBtn');
    const uploadFileName = document.getElementById('uploadFileName');
    const uploadStatusText = document.getElementById('uploadStatusText');
    const uploadPercent = document.getElementById('uploadPercent');
    const uploadProgressBar = document.getElementById('uploadProgressBar');
    const uploadPartInfo = document.getElementById('uploadPartInfo');
    const uploadBytes = document.getElementById('uploadBytes');
    const preprocessSection = document.getElementById('preprocessSection');
    const preprocessPercent = document.getElementById('preprocessPercent');
    const preprocessProgressBar = document.getElementById('preprocessProgressBar');
    const preprocessPageInfo = document.getElementById('preprocessPageInfo');
    const uploadError = document.getElementById('uploadError');
    const uploadErrorText = document.getElementById('uploadErrorText');
    const uploadSuccess = document.getElementById('uploadSuccess');
    const noteIdDisplay = document.getElementById('noteIdDisplay');

    // Filter elements
    const searchInput = document.getElementById('searchInput');
    const fromDate = document.getElementById('fromDate');
    const toDate = document.getElementById('toDate');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');

    let allFiles = [];
    let stats = { total: 0, synced: 0, syncing: 0, errors: 0 };
    let currentWatchedFolder = null;
    let currentSettings = {};
    let isAuthenticated = false;
    let overlayWindowOpen = false;
    let isRecording = false;
    let selectedScreenshots = new Set();
    let selectedRecordings = new Set();
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingStartTime = null;
    let recordingState = 'idle'; // idle, recording, paused
    let allCaptures = []; // Store all captures
    let currentCaptureTab = 'screenshots'; // screenshots or recordings

    // View switching
    const navFiles = document.getElementById('navFiles');
    const navCaptures = document.getElementById('navCaptures');
    const navSettings = document.getElementById('navSettings');
    const filesView = document.getElementById('filesView');
    const capturesView = document.getElementById('capturesView');

    function switchView(viewName) {
      // Hide all views
      filesView.classList.add('hidden');
      capturesView.classList.add('hidden');
      
      // Remove active state from all nav items
      navFiles.classList.remove('bg-blue-600');
      navFiles.classList.add('hover:bg-gray-800');
      navCaptures.classList.remove('bg-blue-600');
      navCaptures.classList.add('hover:bg-gray-800');
      
      // Show selected view and highlight nav
      if (viewName === 'files') {
        filesView.classList.remove('hidden');
        navFiles.classList.add('bg-blue-600');
        navFiles.classList.remove('hover:bg-gray-800');
      } else if (viewName === 'captures') {
        capturesView.classList.remove('hidden');
        navCaptures.classList.add('bg-blue-600');
        navCaptures.classList.remove('hover:bg-gray-800');
        loadCaptures(); // Load captures when view is shown
      }
    }

    navFiles.addEventListener('click', () => switchView('files'));
    navCaptures.addEventListener('click', () => switchView('captures'));
    navSettings.addEventListener('click', async () => {
      // Load settings data before showing modal
      currentSettings = await window.electronAPI.getSettings();
      apiBaseUrlInput.value = currentSettings.apiBaseUrl || 'https://dev.quelo.tech';
      autoSyncInput.checked = currentSettings.autoSync !== undefined ? currentSettings.autoSync : true;
      autoStartInput.checked = currentSettings.autoStart !== undefined ? currentSettings.autoStart : true;
      syncIntervalInput.value = currentSettings.syncInterval || 0;
      maxFileSizeInput.value = currentSettings.maxFileSize || 100;
      ignoreHiddenInput.checked = currentSettings.ignoreHidden !== undefined ? currentSettings.ignoreHidden : true;
      
      // Load and display upload records count
      const uploadRecords = await window.electronAPI.uploadRecords.getAll();
      const recordsCount = Object.keys(uploadRecords).length;
      uploadRecordsCount.textContent = recordsCount;
      
      showModalWithAnimation(settingsModal);
      lucide.createIcons();
    });

    // Initialize with files view
    switchView('files');

    // Modal animation helpers
    function showModalWithAnimation(modal) {
      modal.classList.remove('hidden');
      setTimeout(() => {
        modal.style.opacity = '1';
      }, 10);
    }

    function hideModalWithAnimation(modal) {
      modal.style.opacity = '0';
      setTimeout(() => {
        modal.classList.add('hidden');
      }, 300);
    }

    // Open Quelo.Tech button
    openQueloBtn.addEventListener('click', async () => {
      await window.electronAPI.openExternal('https://quelo.tech');
    });

    // Audio Recording button - supports Record, Pause, Resume
    recordBtn.addEventListener('click', async () => {
      try {
        if (recordingState === 'idle') {
          // Start recording
          await window.electronAPI.recording.start();
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];
          recordingStartTime = Date.now();

          mediaRecorder.ondataavailable = async (event) => {
            if (event.data.size > 0) {
              audioChunks.push(event.data);
              
              // Save chunk to prevent data loss
              const arrayBuffer = await event.data.arrayBuffer();
              await window.electronAPI.recording.saveChunk(arrayBuffer, recordingStartTime);
            }
          };

          mediaRecorder.onstop = async () => {
            // Merge all chunks and save final recording
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const arrayBuffer = await audioBlob.arrayBuffer();
            
            // Save final merged file
            const result = await window.electronAPI.recording.saveFinal(arrayBuffer, recordingStartTime);
            
            if (result.success) {
              alert(`Recording saved: ${result.filename}`);
            } else {
              alert(`Error saving recording: ${result.error}`);
            }

            // Stop all tracks
            stream.getTracks().forEach(track => track.stop());
            
            // Reset UI
            recordingState = 'idle';
            recordBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700', 'bg-red-600', 'hover:bg-red-700');
            recordBtn.classList.add('bg-gray-800', 'hover:bg-gray-700');
            recordBtn.innerHTML = '<i data-lucide="mic"></i><span>Record</span>';
            stopRecordBtn.classList.add('hidden');
            lucide.createIcons();
          };

          // Record in chunks of 10 seconds to prevent data loss
          mediaRecorder.start(10000);

          recordingState = 'recording';
          recordBtn.classList.remove('bg-gray-800', 'hover:bg-gray-700');
          recordBtn.classList.add('bg-red-600', 'hover:bg-red-700');
          recordBtn.innerHTML = '<i data-lucide="pause"></i><span>Pause</span>';
          stopRecordBtn.classList.remove('hidden');
          lucide.createIcons();
        } else if (recordingState === 'recording') {
          // Pause recording
          if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.pause();
            recordingState = 'paused';
            recordBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            recordBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
            recordBtn.innerHTML = '<i data-lucide="play"></i><span>Resume</span>';
            lucide.createIcons();
          }
        } else if (recordingState === 'paused') {
          // Resume recording
          if (mediaRecorder && mediaRecorder.state === 'paused') {
            mediaRecorder.resume();
            recordingState = 'recording';
            recordBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
            recordBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            recordBtn.innerHTML = '<i data-lucide="pause"></i><span>Pause</span>';
            lucide.createIcons();
          }
        }
      } catch (error) {
        console.error('Recording error:', error);
        alert(`Recording error: ${error.message}`);
        recordingState = 'idle';
        recordBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-yellow-600', 'hover:bg-yellow-700');
        recordBtn.classList.add('bg-gray-800', 'hover:bg-gray-700');
        recordBtn.innerHTML = '<i data-lucide="mic"></i><span>Record</span>';
        stopRecordBtn.classList.add('hidden');
        lucide.createIcons();
      }
    });

    // Stop Recording button
    stopRecordBtn.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
      }
    });

    // Captures Modal handlers
    // Tab switching for captures view
    const tabScreenshots = document.getElementById('tabScreenshots');
    const tabRecordings = document.getElementById('tabRecordings');
    const screenshotsTab = document.getElementById('screenshotsTab');
    const recordingsTab = document.getElementById('recordingsTab');
    const screenshotsGrid = document.getElementById('screenshotsGrid');
    const recordingsGrid = document.getElementById('recordingsGrid');

    // Screenshot buttons
    const selectAllScreenshotsBtn = document.getElementById('selectAllScreenshotsBtn');
    const deselectAllScreenshotsBtn = document.getElementById('deselectAllScreenshotsBtn');
    const saveScreenshotsBtn = document.getElementById('saveScreenshotsBtn');
    const deleteScreenshotsBtn = document.getElementById('deleteScreenshotsBtn');

    // Recording buttons
    const selectAllRecordingsBtn = document.getElementById('selectAllRecordingsBtn');
    const deselectAllRecordingsBtn = document.getElementById('deselectAllRecordingsBtn');
    const saveRecordingsBtn = document.getElementById('saveRecordingsBtn');
    const deleteRecordingsBtn = document.getElementById('deleteRecordingsBtn');

    function switchCaptureTab(tabName) {
      currentCaptureTab = tabName;

      // Update tab styling
      const tabs = document.querySelectorAll('.capture-tab');
      tabs.forEach(tab => {
        tab.classList.remove('active');
        tab.style.borderColor = 'transparent';
        tab.style.color = '#6b7280';
      });

      const tabContents = document.querySelectorAll('.capture-tab-content');
      tabContents.forEach(content => content.classList.add('hidden'));

      if (tabName === 'screenshots') {
        tabScreenshots.classList.add('active');
        tabScreenshots.style.borderColor = '#3b82f6';
        tabScreenshots.style.color = '#3b82f6';
        screenshotsTab.classList.remove('hidden');
      } else if (tabName === 'recordings') {
        tabRecordings.classList.add('active');
        tabRecordings.style.borderColor = '#3b82f6';
        tabRecordings.style.color = '#3b82f6';
        recordingsTab.classList.remove('hidden');
      }
    }

    tabScreenshots.addEventListener('click', () => switchCaptureTab('screenshots'));
    tabRecordings.addEventListener('click', () => switchCaptureTab('recordings'));

    // Screenshot handlers
    selectAllScreenshotsBtn.addEventListener('click', () => {
      document.querySelectorAll('.screenshot-checkbox').forEach(cb => {
        cb.checked = true;
        selectedScreenshots.add(cb.dataset.path);
      });
    });

    deselectAllScreenshotsBtn.addEventListener('click', () => {
      document.querySelectorAll('.screenshot-checkbox').forEach(cb => {
        cb.checked = false;
      });
      selectedScreenshots.clear();
    });

    saveScreenshotsBtn.addEventListener('click', async () => {
      if (selectedScreenshots.size === 0) {
        alert('Please select at least one screenshot to save');
        return;
      }

      try {
        saveScreenshotsBtn.disabled = true;
        saveScreenshotsBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i><span>Converting & Saving...</span>';
        lucide.createIcons();

        const result = await window.electronAPI.captures.saveAsNotes(Array.from(selectedScreenshots));
        
        if (result.success) {
          alert(`Successfully converted and saved ${result.saved} screenshot(s) as PDF notes!\nThey will be uploaded automatically.`);
          selectedScreenshots.clear();
          await loadCaptures();
        } else {
          alert(`Error: ${result.error}`);
        }
      } catch (error) {
        alert(`Error saving screenshots: ${error.message}`);
      } finally {
        saveScreenshotsBtn.disabled = false;
        saveScreenshotsBtn.innerHTML = '<i data-lucide="file-text" class="w-4 h-4"></i><span>Save as Notes</span>';
        lucide.createIcons();
      }
    });

    deleteScreenshotsBtn.addEventListener('click', async () => {
      if (selectedScreenshots.size === 0) {
        alert('Please select at least one screenshot to delete');
        return;
      }

      if (!confirm(`Delete ${selectedScreenshots.size} selected screenshot(s)?`)) {
        return;
      }

      try {
        const result = await window.electronAPI.captures.delete(Array.from(selectedScreenshots));
        if (result.success) {
          selectedScreenshots.clear();
          await loadCaptures();
        }
      } catch (error) {
        alert(`Error deleting screenshots: ${error.message}`);
      }
    });

    // Recording handlers
    selectAllRecordingsBtn.addEventListener('click', () => {
      document.querySelectorAll('.recording-checkbox').forEach(cb => {
        cb.checked = true;
        selectedRecordings.add(cb.dataset.path);
      });
    });

    deselectAllRecordingsBtn.addEventListener('click', () => {
      document.querySelectorAll('.recording-checkbox').forEach(cb => {
        cb.checked = false;
      });
      selectedRecordings.clear();
    });

    saveRecordingsBtn.addEventListener('click', async () => {
      if (selectedRecordings.size === 0) {
        alert('Please select at least one recording to save');
        return;
      }

      try {
        saveRecordingsBtn.disabled = true;
        saveRecordingsBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i><span>Saving...</span>';
        lucide.createIcons();

        const result = await window.electronAPI.captures.saveAsNotes(Array.from(selectedRecordings));
        
        if (result.success) {
          alert(`Successfully saved ${result.saved} recording(s) as notes!\nThey will be uploaded automatically.`);
          selectedRecordings.clear();
          await loadCaptures();
        } else {
          alert(`Error: ${result.error}`);
        }
      } catch (error) {
        alert(`Error saving recordings: ${error.message}`);
      } finally {
        saveRecordingsBtn.disabled = false;
        saveRecordingsBtn.innerHTML = '<i data-lucide="file-audio" class="w-4 h-4"></i><span>Save as Notes</span>';
        lucide.createIcons();
      }
    });

    deleteRecordingsBtn.addEventListener('click', async () => {
      if (selectedRecordings.size === 0) {
        alert('Please select at least one recording to delete');
        return;
      }

      if (!confirm(`Delete ${selectedRecordings.size} selected recording(s)?`)) {
        return;
      }

      try {
        const result = await window.electronAPI.captures.delete(Array.from(selectedRecordings));
        if (result.success) {
          selectedRecordings.clear();
          await loadCaptures();
        }
      } catch (error) {
        alert(`Error deleting recordings: ${error.message}`);
      }
    });

    async function loadCaptures() {
      try {
        const captures = await window.electronAPI.captures.getAll();
        allCaptures = captures || [];
        
        // Separate screenshots and recordings
        const screenshots = allCaptures.filter(c => c.type === 'screenshot');
        const recordings = allCaptures.filter(c => c.type === 'audio');

        // Render screenshots
        if (screenshots.length === 0) {
          screenshotsGrid.innerHTML = `
            <div class="col-span-full text-center py-20">
              <div class="text-gray-700 mb-4">
                <i data-lucide="image" class="w-16 h-16 mx-auto"></i>
              </div>
              <h3 class="text-sm font-medium text-gray-500 mb-1">No Screenshots Yet</h3>
              <p class="text-xs text-gray-600">Take screenshots using the widget to see them here</p>
            </div>
          `;
        } else {
          screenshotsGrid.innerHTML = screenshots.map(capture => {
            const isSelected = selectedScreenshots.has(capture.path);
            
            return `
              <div class="rounded-lg overflow-hidden hover:ring-2 hover:ring-blue-500 transition" style="background-color: #0d1117; border: 1px solid #1f2937;">
                <div class="aspect-video flex items-center justify-center relative bg-gray-900">
                  <img src="file://${capture.path}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                  <div style="display:none;" class="w-full h-full items-center justify-center">
                    <i data-lucide="image" class="w-12 h-12 text-gray-600"></i>
                  </div>
                  <div class="absolute top-2 left-2">
                    <input type="checkbox" class="screenshot-checkbox w-5 h-5 rounded cursor-pointer" data-path="${capture.path}" ${isSelected ? 'checked' : ''}>
                  </div>
                  <div class="absolute top-2 right-2">
                    <span class="px-2 py-0.5 text-xs font-medium rounded bg-blue-900/70 text-blue-200 border border-blue-700 backdrop-blur-sm">
                      <i data-lucide="camera" class="inline w-3 h-3"></i> Screenshot
                    </span>
                  </div>
                </div>
                <div class="p-3">
                  <h3 class="font-medium text-white text-xs mb-1 truncate" title="${capture.name}">${capture.name}</h3>
                  <div class="flex items-center justify-between text-xs text-gray-500">
                    <span>${(capture.size / 1024).toFixed(1)} KB</span>
                    <span>${new Date(capture.timestamp).toLocaleString()}</span>
                  </div>
                </div>
              </div>
            `;
          }).join('');

          // Add event listeners to screenshot checkboxes
          document.querySelectorAll('.screenshot-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
              if (e.target.checked) {
                selectedScreenshots.add(e.target.dataset.path);
              } else {
                selectedScreenshots.delete(e.target.dataset.path);
              }
            });
          });
        }

        // Render recordings
        if (recordings.length === 0) {
          recordingsGrid.innerHTML = `
            <div class="col-span-full text-center py-20">
              <div class="text-gray-700 mb-4">
                <i data-lucide="mic" class="w-16 h-16 mx-auto"></i>
              </div>
              <h3 class="text-sm font-medium text-gray-500 mb-1">No Recordings Yet</h3>
              <p class="text-xs text-gray-600">Click Record to start capturing audio</p>
            </div>
          `;
        } else {
          recordingsGrid.innerHTML = recordings.map(capture => {
            const isSelected = selectedRecordings.has(capture.path);
            
            return `
              <div class="rounded-lg overflow-hidden hover:ring-2 hover:ring-blue-500 transition" style="background-color: #0d1117; border: 1px solid #1f2937;">
                <div class="aspect-video flex items-center justify-center relative" style="background: linear-gradient(135deg, #1a1a2e 0%, #2d2d44 100%);">
                  <i data-lucide="music" class="w-12 h-12 text-blue-400"></i>
                  <div class="absolute top-2 left-2">
                    <input type="checkbox" class="recording-checkbox w-5 h-5 rounded cursor-pointer" data-path="${capture.path}" ${isSelected ? 'checked' : ''}>
                  </div>
                  <div class="absolute top-2 right-2">
                    <span class="px-2 py-0.5 text-xs font-medium rounded bg-blue-900/70 text-blue-200 border border-blue-700 backdrop-blur-sm">
                      <i data-lucide="mic" class="inline w-3 h-3"></i> Audio
                    </span>
                  </div>
                </div>
                <div class="p-3">
                  <h3 class="font-medium text-white text-xs mb-1 truncate" title="${capture.name}">${capture.name}</h3>
                  <div class="flex items-center justify-between text-xs text-gray-500">
                    <span>${(capture.size / 1024).toFixed(1)} KB</span>
                    <span>${new Date(capture.timestamp).toLocaleString()}</span>
                  </div>
                </div>
              </div>
            `;
          }).join('');

          // Add event listeners to recording checkboxes
          document.querySelectorAll('.recording-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
              if (e.target.checked) {
                selectedRecordings.add(e.target.dataset.path);
              } else {
                selectedRecordings.delete(e.target.dataset.path);
              }
            });
          });
        }

        lucide.createIcons();
      } catch (error) {
        console.error('Error loading captures:', error);
        const errorMsg = `
          <div class="col-span-full text-center py-20">
            <p class="text-red-400">Error loading captures: ${error.message}</p>
          </div>
        `;
        screenshotsGrid.innerHTML = errorMsg;
        recordingsGrid.innerHTML = errorMsg;
      }
    }

    // Check authentication status on load
    async function checkAuthStatus() {
      console.log('[Auth] Checking authentication status...');
      const result = await window.electronAPI.auth.isAuthenticated();
      console.log('[Auth] Result:', result);
      isAuthenticated = result.isAuthenticated;
      console.log('[Auth] isAuthenticated:', isAuthenticated);
      updateAuthUI();
      
      // Note: We don't validate the token on startup to ensure login persistence
      // Token validation will happen automatically when making API calls
      // If you want to validate manually, uncomment below:
      /*
      if (isAuthenticated) {
        const validation = await window.electronAPI.auth.validateToken();
        if (!validation.isValid) {
          isAuthenticated = false;
          updateAuthUI();
        }
      }
      */
    }

    function updateAuthUI() {
      if (isAuthenticated) {
        authStatus.style.backgroundColor = '#0a1929';
        authStatus.style.border = '1px solid #1e3a5f';
        authStatusText.classList.remove('text-gray-400');
        authStatusText.classList.add('text-blue-400');
        authStatusText.innerHTML = '<i data-lucide="check" class="inline w-3 h-3"></i> Logged in';
        lucide.createIcons();
        loginBtn.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
      } else {
        authStatus.style.backgroundColor = '#1a1a1a';
        authStatus.style.border = '1px solid #2a2a2a';
        authStatusText.classList.remove('text-blue-400');
        authStatusText.classList.add('text-gray-400');
        authStatusText.textContent = 'Not logged in';
        loginBtn.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
      }
    }

    // Login handler
    loginBtn.addEventListener('click', async () => {
      try {
        loginBtn.disabled = true;
        loginBtn.textContent = 'Logging in...';
        
        const result = await window.electronAPI.auth.login();
        
        if (result.success) {
          isAuthenticated = true;
          updateAuthUI();
          alert('Login successful! You can now upload files.');
        } else {
          alert(`Login failed: ${result.error}`);
        }
      } catch (error) {
        alert(`Login error: ${error.message}`);
      } finally {
        loginBtn.disabled = false;
        loginBtn.innerHTML = '<i data-lucide="lock"></i><span>Login</span>';
        lucide.createIcons();
      }
    });

    // Logout handler
    logoutBtn.addEventListener('click', async () => {
      if (confirm('Are you sure you want to logout?')) {
        const result = await window.electronAPI.auth.logout();
        if (result.success) {
          isAuthenticated = false;
          updateAuthUI();
          alert('Logged out successfully');
        }
      }
    });

    closeSettingsBtn.addEventListener('click', () => {
      hideModalWithAnimation(settingsModal);
    });

    cancelSettingsBtn.addEventListener('click', () => {
      hideModalWithAnimation(settingsModal);
    });
    
    // Sync from server handler
    syncFromServerBtn.addEventListener('click', async () => {
      const originalText = syncFromServerBtn.innerHTML;
      syncFromServerBtn.disabled = true;
      syncFromServerBtn.innerHTML = '<i data-lucide="loader-2" class="inline w-3 h-3 animate-spin"></i> Syncing...';
      lucide.createIcons();
      
      try {
        const result = await window.electronAPI.uploadRecords.syncFromServer();
        if (result.success) {
          // Refresh the count
          const uploadRecords = await window.electronAPI.uploadRecords.getAll();
          const recordsCount = Object.keys(uploadRecords).length;
          uploadRecordsCount.textContent = recordsCount;
          
          alert(`Sync completed! Found ${result.total} files on server, synced ${result.synced} new records.`);
        } else {
          alert(`Sync failed: ${result.error}`);
        }
      } catch (error) {
        alert(`Sync error: ${error.message}`);
      } finally {
        syncFromServerBtn.disabled = false;
        syncFromServerBtn.innerHTML = originalText;
        lucide.createIcons();
      }
    });
    
    // Clear upload records handler
    clearRecordsBtn.addEventListener('click', async () => {
      if (confirm('Are you sure you want to clear all upload records? This will cause all files to be re-uploaded on the next sync.')) {
        const result = await window.electronAPI.uploadRecords.clearAll();
        if (result.success) {
          uploadRecordsCount.textContent = '0';
          alert('Upload records cleared successfully!');
        }
      }
    });

    saveSettingsBtn.addEventListener('click', async () => {
      const apiBaseUrl = apiBaseUrlInput.value.trim();
      const autoSync = autoSyncInput.checked;
      const autoStart = autoStartInput.checked;
      const syncInterval = parseInt(syncIntervalInput.value) || 0;
      const maxFileSize = parseInt(maxFileSizeInput.value) || 100;
      const ignoreHidden = ignoreHiddenInput.checked;

      if (apiBaseUrl) {
        await window.electronAPI.setApiBaseUrl(apiBaseUrl);
      }
      
      // Save other settings
      await window.electronAPI.updateSettings({
        autoSync,
        autoStart,
        syncInterval,
        maxFileSize,
        ignoreHidden
      });

      hideModalWithAnimation(settingsModal);
      
      // Show confirmation
      alert('Settings saved successfully!');
    });

    // Upload Progress Modal Handlers
    closeUploadModal.addEventListener('click', () => {
      hideModalWithAnimation(uploadProgressModal);
    });

    closeUploadModalBtn.addEventListener('click', () => {
      hideModalWithAnimation(uploadProgressModal);
    });

    function showUploadProgress(fileName) {
      uploadFileName.textContent = fileName;
      uploadStatusText.textContent = 'Initializing...';
      uploadPercent.textContent = '0%';
      uploadProgressBar.style.width = '0%';
      uploadPartInfo.textContent = '';
      uploadBytes.textContent = '';
      preprocessSection.classList.add('hidden');
      uploadError.classList.add('hidden');
      uploadSuccess.classList.add('hidden');
      showModalWithAnimation(uploadProgressModal);
      lucide.createIcons();
    }

    function updateUploadProgress(data) {
      if (data.uploadProgress !== undefined) {
        uploadPercent.textContent = `${data.uploadProgress}%`;
        uploadProgressBar.style.width = `${data.uploadProgress}%`;
      }

      if (data.currentPart && data.totalParts) {
        uploadPartInfo.textContent = `Part ${data.currentPart} of ${data.totalParts}`;
      }

      if (data.uploadedBytes && data.totalBytes) {
        const mbUploaded = (data.uploadedBytes / 1024 / 1024).toFixed(2);
        const mbTotal = (data.totalBytes / 1024 / 1024).toFixed(2);
        uploadBytes.textContent = `${mbUploaded} / ${mbTotal} MB`;
      }
    }

    function updateUploadStatus(data) {
      uploadStatusText.textContent = data.message || data.status;

      if (data.status === 'preprocessing') {
        preprocessSection.classList.remove('hidden');
        
        if (data.preprocessProgress !== undefined) {
          preprocessPercent.textContent = `${data.preprocessProgress}%`;
          preprocessProgressBar.style.width = `${data.preprocessProgress}%`;
        }

        if (data.currentPage && data.totalPages) {
          preprocessPageInfo.textContent = `Processing page ${data.currentPage} of ${data.totalPages}`;
        }
      }

      if (data.status === 'completed') {
        uploadSuccess.classList.remove('hidden');
        if (data.noteId) {
          noteIdDisplay.textContent = ` Note ID: ${data.noteId}`;
        }
      }

      if (data.status === 'error') {
        uploadError.classList.remove('hidden');
        uploadErrorText.textContent = data.error || 'Upload failed';
      }
    }

    // File selection - removed, using default folder

    stopBtn.addEventListener('click', async () => {
      await window.electronAPI.stopWatching();
      folderInfo.classList.add('hidden');
      stopBtn.disabled = true;
      currentWatchedFolder = null;
    });
    
    // Screenshot overlay toggle
    overlayBtn.addEventListener('click', async () => {
      try {
        const result = await window.electronAPI.overlay.toggle();
        overlayWindowOpen = result.visible;
        
        if (result.visible) {
          overlayBtn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
          overlayBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
          overlayBtn.innerHTML = '<i data-lucide="camera"></i><span>Close Widget</span>';
        } else {
          overlayBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
          overlayBtn.classList.add('bg-gray-700', 'hover:bg-gray-600');
          overlayBtn.innerHTML = '<i data-lucide="camera"></i><span>Open Widget</span>';
        }
        lucide.createIcons();
      } catch (error) {
        console.error('Failed to toggle overlay:', error);
      }
    });

    // Filters
    searchInput.addEventListener('input', filterFiles);
    fromDate.addEventListener('change', filterFiles);
    toDate.addEventListener('change', filterFiles);
    
    clearFiltersBtn.addEventListener('click', () => {
      searchInput.value = '';
      fromDate.value = '';
      toDate.value = '';
      filterFiles();
    });

    // Listen for recording trigger from overlay
    window.electronAPI.onTriggerRecording(() => {
      recordBtn.click();
    });

    function filterFiles() {
      const searchTerm = searchInput.value.toLowerCase();
      const from = fromDate.value ? new Date(fromDate.value) : null;
      const to = toDate.value ? new Date(toDate.value) : null;

      const filtered = allFiles.filter(file => {
        const matchesSearch = !searchTerm || file.name.toLowerCase().includes(searchTerm);
        const fileDate = new Date(file.timestamp || file.modified);
        const matchesFrom = !from || fileDate >= from;
        const matchesTo = !to || fileDate <= new Date(to.getTime() + 86400000); // Add 1 day
        
        return matchesSearch && matchesFrom && matchesTo;
      });

      console.log(`[Filter] Showing ${filtered.length} of ${allFiles.length} files`);
      renderFiles(filtered);
    }

    function addOrUpdateFile(fileData) {
      const existingIndex = allFiles.findIndex(f => f.path === fileData.path);
      
      if (existingIndex >= 0) {
        // Update existing
        const oldStatus = allFiles[existingIndex].status;
        allFiles[existingIndex] = { ...allFiles[existingIndex], ...fileData };
        
        // Update stats
        if (oldStatus === 'syncing' && fileData.status === 'synced') {
          stats.syncing--;
          stats.synced++;
        } else if (oldStatus === 'syncing' && fileData.status === 'error') {
          stats.syncing--;
          stats.errors++;
        } else if (oldStatus === 'pending' && fileData.status === 'syncing') {
          stats.syncing++;
        } else if (oldStatus === 'pending' && fileData.status === 'synced') {
          stats.synced++;
        } else if (oldStatus === 'pending' && fileData.status === 'error') {
          stats.errors++;
        }
      } else {
        // Add new
        allFiles.unshift(fileData);
        stats.total++;
        
        if (fileData.status === 'syncing') stats.syncing++;
        else if (fileData.status === 'synced') stats.synced++;
        else if (fileData.status === 'error') stats.errors++;
        else if (fileData.status === 'pending') {
          // Pending files don't count in syncing, synced, or errors
          // They just count toward total
        }
      }
      
      updateStats();
      filterFiles();
    }

    function updateStats() {
      document.getElementById('statTotal').textContent = stats.total;
      document.getElementById('statSynced').textContent = stats.synced;
      document.getElementById('statSyncing').textContent = stats.syncing;
      document.getElementById('statErrors').textContent = stats.errors;
    }

    function renderFiles(filesToRender = allFiles) {
      if (filesToRender.length === 0) {
        filesList.innerHTML = `
          <div class="col-span-full text-center py-20">
            <div class="text-gray-700 mb-4">
              <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            </div>
            <h3 class="text-sm font-medium text-gray-500 mb-1">No Files Found</h3>
            <p class="text-xs text-gray-600">${allFiles.length === 0 ? 'Select a folder to start syncing files' : 'Try adjusting your filters'}</p>
          </div>
        `;
        return;
      }

      filesList.innerHTML = filesToRender.map(file => {
        const statusColors = {
          syncing: 'bg-blue-900/50 text-blue-300 border border-blue-800',
          synced: 'bg-blue-900/30 text-blue-200 border border-blue-900',
          error: 'bg-red-900/50 text-red-300 border border-red-800',
          ignored: 'bg-gray-800 text-gray-400 border border-gray-700',
          pending: 'bg-yellow-900/30 text-yellow-200 border border-yellow-900'
        };

        const statusIcons = {
          syncing: '<i data-lucide="loader-2" class="inline w-3 h-3 animate-spin"></i>',
          synced: '<i data-lucide="check-circle" class="inline w-3 h-3"></i>',
          error: '<i data-lucide="alert-circle" class="inline w-3 h-3"></i>',
          ignored: '<i data-lucide="minus-circle" class="inline w-3 h-3"></i>',
          pending: '<i data-lucide="clock" class="inline w-3 h-3"></i>'
        };
        
        const fileDate = file.timestamp || file.modified;

        return `
          <div class="rounded-lg overflow-hidden hover:ring-1 hover:ring-gray-700 transition group" style="background-color: #0d1117; border: 1px solid #1f2937;">
            <!-- PDF Preview -->
            <div class="aspect-[3/4] flex items-center justify-center relative" style="background: linear-gradient(135deg, #1a0f0f 0%, #2d1a1a 100%);">
              <svg class="w-16 h-16 text-red-900/40 group-hover:text-red-900/60 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              <div class="absolute top-2 right-2">
                <span class="px-2 py-0.5 text-xs font-medium rounded ${statusColors[file.status] || statusColors.pending}">
                  ${statusIcons[file.status] || statusIcons.pending} ${file.status || 'pending'}
                </span>
              </div>
              ${file.uploaded ? '<div class="absolute top-2 left-2"><span class="px-2 py-0.5 text-xs font-medium rounded bg-blue-900/50 text-blue-300 border border-blue-800"><i data-lucide="upload" class="inline w-3 h-3"></i> Uploaded</span></div>' : ''}
            </div>
            
            <!-- File Info -->
            <div class="p-3">
              <h3 class="font-medium text-white text-sm mb-1 truncate" title="${file.name}">${file.name}</h3>
              <div class="flex items-center justify-between text-xs text-gray-500">
                <span>${(file.size / 1024).toFixed(1)} KB</span>
                <span>${new Date(fileDate).toLocaleDateString()}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Re-initialize Lucide icons after rendering
      lucide.createIcons();
    }

    // Listen for sync events
    window.electronAPI.onSyncStatus((data) => {
      const { file, status, type, size, error, reason } = data;
      
      const fileData = {
        name: file.split(/[/\\]/).pop(),
        path: file,
        size: size || 0,
        type: 'pdf',
        status: status === 'deleted' ? 'error' : status,
        timestamp: new Date(),
        uploaded: false
      };

      if (status === 'deleted') {
        // Remove from list
        const index = allFiles.findIndex(f => f.path === file);
        if (index >= 0) {
          const removedFile = allFiles[index];
          allFiles.splice(index, 1);
          stats.total--;
          
          if (removedFile.status === 'synced') stats.synced--;
          else if (removedFile.status === 'syncing') stats.syncing--;
          else if (removedFile.status === 'error') stats.errors--;
          
          updateStats();
          filterFiles();
        }
      } else if (status === 'skipped') {
        // File was skipped because it's already uploaded
        fileData.status = 'synced';
        fileData.uploaded = true;
        console.log(`[UI] File skipped (already uploaded): ${file}`);
        addOrUpdateFile(fileData);
      } else {
        addOrUpdateFile(fileData);
      }
    });

    window.electronAPI.onWatchStarted((folder) => {
      console.log('Watching:', folder);
    });

    // Listen for initial files when watch starts
    window.electronAPI.onInitialFiles((files) => {
      console.log(`[UI] Received ${files.length} initial files`);
      
      // Clear existing files and add the initial ones
      allFiles = [];
      stats = { total: 0, synced: 0, syncing: 0, errors: 0 };
      
      files.forEach(file => {
        addOrUpdateFile(file);
      });
      
      updateStats();
      filterFiles();
    });

    // Listen for upload progress events
    window.electronAPI.onUploadProgress((data) => {
      updateUploadProgress(data);
    });

    // Listen for upload status events
    window.electronAPI.onUploadStatus((data) => {
      updateUploadStatus(data);
    });

    console.log('[Script] Event listeners registered, starting initialization...');

    // Initialize
    (async () => {
      console.log('[App] Initialization started');
      
      // Check authentication first
      await checkAuthStatus();
      
      const watchedFolder = await window.electronAPI.getWatchedFolder();
      if (watchedFolder) {
        currentWatchedFolder = watchedFolder;
        folderPath.textContent = watchedFolder;
        folderInfo.classList.remove('hidden');
        stopBtn.disabled = false;
        manualSyncBtn.disabled = false;
        if (isAuthenticated) {
          manualUploadBtn.disabled = false;
        }
        
        // Load existing files from the watched directory
        const files = await window.electronAPI.getWatchedFiles();
        console.log(`[UI Init] Loaded ${files.length} files from watched directory`);
        console.log('[UI Init] Sample file:', files[0]);
        
        // Populate the UI with the files
        files.forEach(file => {
          addOrUpdateFile(file);
        });
        
        console.log('[UI Init] After adding files - allFiles:', allFiles.length);
        console.log('[UI Init] Stats:', stats);
        
        // Update stats
        updateStats();
        filterFiles();
      }
      
      // Initialize Lucide icons
      lucide.createIcons();
      console.log('[App] Initialization complete');
    })();
  </script>
</body>
</html>